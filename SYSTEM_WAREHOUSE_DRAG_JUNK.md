# 系统说明：仓库、拖拽与杂物区

## 1. 相关代码

- `assets/scripts/ui/Warehouse.ts`
- `assets/scripts/ui/DragManager.ts`
- `assets/scripts/ui/PlacedItem.ts`
- `assets/scripts/ui/ItemSlot.ts`

## 2. 仓库系统

### 2.1 网格与布局

- 仓库根据屏幕宽度自适应 `cellSize`
- 网格锚点语义统一为左上角
- 提供坐标转换：
  - UI 坐标 -> 仓库本地
  - 本地坐标 -> 网格坐标
  - 网格坐标 -> 物体左上角位置

### 2.2 放置判定

- 仅 `shape=1` 参与边界与重叠检测
- `shape=2`（星星）不占格，不阻挡放置
- 合法放置会创建新的 `PlacedItem` 节点并入 `_placedItems`

## 3. 拖拽系统

### 3.1 拖拽来源

- 槽位物品
- 仓库已放置物品
- 杂物区物品

### 3.2 拖拽预览

- `DragManager` 负责预览节点创建与跟随
- 预览使用物品副本，避免取消拖拽污染原数据
- 按 `R` 可旋转预览与放置逻辑

### 3.3 成功/失败流程

- 放置成功：
  - 槽位来源：清除槽位
  - 仓库来源：销毁旧放置节点，保留新位置
  - 杂物来源：销毁杂物节点
- 放置失败：
  - 仓库来源恢复原位置
  - 杂物来源恢复原物理位置

## 4. 杂物区系统（物理）

### 4.1 区域结构

- 仓库上方单独区域 `JunkArea`
- 包含背景、左右墙、底墙（静态刚体）
- 中间为 `JunkItems` 动态堆积区

### 4.2 物理物体生成

- 拖拽结束未放入仓库时，若松手在杂物区内，则转为物理物体
- 每个物体使用动态刚体 `RigidBody2D`
- 碰撞体按 `shape=1` 逐格生成（避免镂空误碰撞）

## 5. 关键设计点

- 坐标逻辑统一，避免预览与落点偏移
- 拖拽显示与仓库判定分离，职责明确
- 支持多来源拖拽，流程对齐一致
