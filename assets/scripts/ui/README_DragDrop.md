# 拖拽放置系统使用说明

## 概述

已实现完整的物品拖拽放置系统，支持：
- 从物品槽位拖拽物品
- 在仓库中预览放置位置（绿色=可放置，红色=不可放置）
- 自动检测重叠和边界
- 放置后自动从槽位移除物品

## 组件说明

### 1. DragManager（拖拽管理器）
- **位置**：自动创建在 Canvas 节点下
- **功能**：管理全局拖拽状态和拖拽预览
- **单例模式**：确保只有一个实例

### 2. ItemSlot（物品槽位）
- **功能**：显示物品，支持拖拽
- **拖拽触发**：点击槽位中的物品开始拖拽
- **自动移除**：物品成功放置到仓库后自动清空

### 3. Warehouse（仓库）
- **功能**：接收拖拽的物品并放置
- **预览功能**：拖拽时显示绿色（可放置）或红色（不可放置）预览
- **重叠检测**：自动检测物品之间是否重叠
- **边界检测**：自动检测物品是否超出仓库范围

### 4. PlacedItem（已放置物品）
- **功能**：在仓库中显示已放置的物品
- **自动创建**：放置物品时自动创建

## 使用方法

### 基本使用

1. **确保场景中有以下节点结构**：
   ```
   Canvas
   ├── ItemPanel (物品面板)
   │   ├── Slot_0 (物品槽位)
   │   ├── Slot_1 (物品槽位)
   │   └── Slot_2 (物品槽位)
   ├── Warehouse (仓库)
   └── DragManager (自动创建)
   ```

2. **运行游戏**：
   - 物品面板会自动生成三个随机物品
   - 点击物品槽位中的物品开始拖拽
   - 拖拽到仓库上方时，会显示预览（绿色=可放置，红色=不可放置）
   - 松开鼠标完成放置

### 拖拽流程

1. **开始拖拽**：
   - 点击物品槽位中的物品
   - 自动创建拖拽预览（跟随鼠标）

2. **拖拽中**：
   - 鼠标移动到仓库上方时显示放置预览
   - 绿色预览 = 可以放置（不重叠、不越界）
   - 红色预览 = 不能放置（重叠或越界）

3. **结束拖拽**：
   - 在仓库有效位置松开鼠标 = 放置物品
   - 在仓库外松开鼠标 = 取消放置
   - 放置成功后，物品从槽位中移除

## API 说明

### Warehouse 主要方法

```typescript
// 检查是否可以放置物品
canPlaceItem(item: BaseItem, row: number, col: number): boolean

// 放置物品
placeItem(item: BaseItem, row: number, col: number, addToPlacedList: boolean): boolean

// 获取已放置的物品列表
getPlacedItems(): PlacedItemData[]

// 清空仓库
clearAllItems(): void
```

### ItemSlot 主要方法

```typescript
// 设置物品
setItem(item: BaseItem | null): void

// 获取当前物品
getItem(): BaseItem | null

// 移除物品（拖拽后调用）
removeItem(): void
```

### DragManager 主要方法

```typescript
// 开始拖拽
startDrag(item: BaseItem, sourceSlot: Node, touch: EventTouch): void

// 结束拖拽
endDrag(): void

// 获取当前拖拽的物品
getDraggingItem(): BaseItem | null

// 是否正在拖拽
isDragging(): boolean
```

## 游戏玩法

### 目标
将所有物品放入仓库，物品之间不能重叠，物品不能超出仓库边界。

### 规则
1. 每次刷新会生成三个随机物品
2. 物品必须完全放在仓库内
3. 物品之间不能重叠
4. 放置成功的物品会从槽位中移除
5. 可以继续刷新获取新物品

### 策略提示
- 先放置大物品，再填充小物品
- 注意物品的形状，合理规划空间
- 如果无法放置，可以刷新获取新物品

## 注意事项

1. **拖拽管理器**：会自动创建，无需手动添加
2. **坐标系统**：使用 UI 坐标系统，确保所有节点都在 Canvas 下
3. **触摸事件**：支持鼠标和触摸屏操作
4. **性能优化**：预览节点会在拖拽结束时自动销毁

## 扩展功能建议

可以添加的功能：
- 物品旋转功能（点击物品旋转90度）
- 撤销功能（撤销最后一次放置）
- 计分系统（根据放置的物品数量计分）
- 音效反馈（放置成功/失败的音效）
- 动画效果（放置时的动画）

## 故障排除

### 问题：拖拽不工作
- 检查 ItemSlot 是否有 ItemDisplay 组件
- 检查 DragManager 是否已创建
- 检查触摸事件是否正确绑定

### 问题：预览不显示
- 检查 Warehouse 的 onEnable 是否正确调用
- 检查坐标转换是否正确

### 问题：物品无法放置
- 检查物品是否超出仓库边界
- 检查是否与已放置的物品重叠
- 检查 canPlaceItem 方法的逻辑
